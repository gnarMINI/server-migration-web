<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서버 이전 리스트</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/icons/bootstrap-icons.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            font-size: 13px;
        }
        .container {
            max-width: 100%;
            width: 100%;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .box {
            display: inline-block;      
            width: fit-content;         
            max-width: 100%;            
            border: 2px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            margin: 0 auto 20px auto;
            background: #fff;
        }

        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        th {
            background: #ddd;
        }
        .status-progress {
            background-color: yellow;
        }

        .status-complete {
            background-color: gray;
            color: white;
        }
        .small-input {
            width: 70px;
        }
        select option[disabled] {
            color: gray;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-top: 0;  
            margin-bottom: 15px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            color: #333;
        }
        .inline-group {
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        .middle-input {
            width: 80px;
        }
        .link-input {
            width: 500px;
        }
        .status-default {
            background-color: white;
            color: black;
        }

        .status-working {
            background-color: green;
            color: white;
        }

        .status-complete {
            background-color: black;
            color: white;
        }
        .status-btn {
            border: none;
            padding: 6px 12px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
        }

        .status-default {
            background-color: white;
            color: black;
            border: 1px solid #ccc;
        }

        .status-working {
            background-color: green;
            color: white;
        }

        .status-complete {
            background-color: black;
            color: white;
        }
        .urgent-1week {
            background-color: #ffe5e5 !important;
        }
        .urgent-2week {
            background-color: #fff7d9 !important;
        }
        .urgent-3week {
            background-color: #f2fbff !important;
        }
        .completed-row { 
            background-color: #e0e0e0 !important; 
        }
        .pagination-btn {
            margin: 0 3px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            cursor: pointer;
        }
        .pagination-btn.active {
            font-weight: bold;
            background: #ddd;
        }
        #centerFilter button {
            padding: 5px 12px;
            margin-right: 6px;
            border: 1px solid #ccc;
            background: #f4f4f4;
            border-radius: 4px;
            cursor: pointer;
        }
        #centerFilter button:hover {
            background: #ddd;
        }
        .filter-btn {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background: #f0f0f0;
        cursor: pointer;
        border-radius: 5px;
        margin-right: 6px;
        }

        .filter-btn.active {
        background-color: #0d6efd;
        color: white;
        font-weight: bold;
        border-color: #0d6efd;
        }


    </style>
</head>
<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" >Kakao IDC team 서버 이전 리스트</a>
      
      </div>
    </div>
  </nav>
<body>
    <div class="container-fluid my-4">

      
        <!-- 작업 등록 박스 -->
        <div class="row">
            <div class="col-lg-8">
              <div class="card card-form p-3">
              <h5 class="card-title mb-1">작업 등록</h5>
              <hr>
              <form>
                <div class="row g-2 mb-3">
                  <div class="col-md-4">
                    <label class="form-label">서버 이전 종류</label>
                    <select id="migrationType" class="form-select form-select-sm" onchange="toggleCenterSelect()">
                      <option value="" disabled selected>작업 종류 선택</option>
                      <option value="external">센터 간 이전</option>
                      <option value="internal">내부 이전</option>
                    </select>
                  </div>
                  <div id="centerSelectSection" class="col-md-8 d-none">
                    <label class="form-label">센터 간 이전</label>
                    <div class="input-group input-group-sm">
                      <select id="fromCenter" class="form-select">
                        <option disabled selected>출발 센터</option>
                        <option>AS</option><option>AY</option><option>PG</option><option>MD</option><option>GS</option><option>HN</option>
                      </select>
                      <span class="input-group-text">→</span>
                      <select id="toCenter" class="form-select">
                        <option disabled selected>도착 센터</option>
                        <option>AS</option><option>AY</option><option>PG</option><option>MD</option><option>GS</option><option>HN</option>
                      </select>
                    </div>
                  </div>
                  <div id="internalCenterSection" class="col-md-4 d-none">
                    <label class="form-label">작업 센터</label>
                    <select id="internalCenter" class="form-select form-select-sm">
                      <option disabled selected>센터 선택</option>
                      <option>AS</option><option>AY</option><option>PG</option><option>MD</option><option>GS</option><option>HN</option>
                    </select>
                  </div>
                </div>
              
                <div class="row g-2 mb-3">
                  <div class="col-md-2">
                    <label class="form-label">벤더</label>
                    <select id="vendor" class="form-select form-select-sm">
                      <option disabled selected>벤더 선택</option>
                      <option>KAYTUS</option><option>XFUSION</option><option>DELL</option>
                      <option>HPE</option><option>SUPERMICRO</option><option>복합</option><option>기타</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">서버 수</label>
                    <input id="serverCount" type="number" class="form-control form-control-sm" placeholder="ex) 10">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">요청자</label>
                    <input id="requester" type="text" class="form-control form-control-sm" placeholder="ex) gnar">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">희망 완료일</label>
                    <input id="dueDate" type="date" class="form-control form-control-sm">
                  </div>
                    <div class="col-md-4">
                      <label class="form-label">작업 옵션</label>
                      <div class="card p-1 bg-light">
                          <div class="d-flex gap-3 align-items-center justify-content-center">
                          <div class="form-check">
                            <input id="partWork" class="form-check-input" type="checkbox">
                            <label class="form-check-label" for="partWork">파트작업</label>
                          </div>
                          <div class="form-check">
                            <input id="osInstall" class="form-check-input" type="checkbox">
                            <label class="form-check-label" for="osInstall">OS 설치</label>
                          </div>
                          <div class="form-check">
                            <input id="vendorMigration" class="form-check-input" type="checkbox">
                            <label class="form-check-label" for="vendorMigration">벤더 이전</label>
                          </div>
                          <div class="form-check">
                            <input id="serverConfig" class="form-check-input" type="checkbox">
                            <label class="form-check-label" for="serverConfig">서버 설정</label>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
              

                  <div class="mb-3">
                    <label class="form-label">비고</label>
                    <textarea id="memo" class="form-control form-control-sm" rows="1" placeholder="비고를 입력해주세요"></textarea>
                  </div>

                  <div class="mb-2" style="font-size: 12px;">
                    <label class="form-label" style="font-size: 12px;">비고 키워드 추가</label>
                    <div id="memoKeywordButtons" class="d-flex flex-wrap gap-1 mt-1">
                      <button type="button" class="btn btn-outline-secondary btn-xs py-0 px-1" style="font-size: 11px;" onclick="addMemoTag('25G NIC 증설')">25G NIC 증설</button>
                      <button type="button" class="btn btn-outline-secondary btn-xs py-0 px-1" style="font-size: 11px;" onclick="addMemoTag('10G NIC 제거')">10G NIC 제거</button>
                      <button type="button" class="btn btn-outline-secondary btn-xs py-0 px-1" style="font-size: 11px;" onclick="addMemoTag('메모리 증설')">메모리 증설</button>
                      <button type="button" class="btn btn-outline-secondary btn-xs py-0 px-1" style="font-size: 11px;" onclick="addMemoTag('메모리 제거')">메모리 제거</button>
                      <button type="button" class="btn btn-outline-secondary btn-xs py-0 px-1" style="font-size: 11px;" onclick="addMemoTag('RAID 작업')">RAID 작업</button>
                    </div>
                  </div>
              
                <div class="mb-3">
                  <label class="form-label">Agit Link</label>
                  <input id="agitLink" type="text" class="form-control form-control-sm" placeholder="정확히 입력해주세요">
                </div>
              
                <div class="d-flex gap-2">
                  <button id="saveTaskButton" type="button" class="btn btn-sm btn-primary" onclick="saveTask()">SAVE</button>
                  <button id="resetBtn" type="button" class="btn btn-sm btn-warning" onclick="resetForm()">초기화</button>
                  <button id="cancelBtn" type="button" class="btn btn-sm btn-danger" style="display: none;" onclick="cancelEdit()">취소</button>
                </div>
              
                <!-- 숨겨진 체크박스 -->
                <input type="checkbox" id="centerMoved" hidden>
                <input type="checkbox" id="workFile" hidden>
                <input type="checkbox" id="mount" hidden>
                <input type="checkbox" id="cabling" hidden>
                <input type="checkbox" id="unmount" hidden>

              </form>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card card-summary shadow-sm">
              <div class="card-body">
                <h5 class="card-title mb-2">
                  📊 작업 현황 <span class="text-muted" style="font-size: 13px;">(센터별 서버 수)</span>
                </h5>
                <hr>
                <div id="centerProgressStats" style="font-size: 13px;">
                  <!-- JS로 Progress Bar 삽입 -->
                </div>
                <p class="mt-3 mb-0 text-end text-muted" id="totalServerCount" style="font-size: 12px;"></p>
              </div>
            </div>
          </div>
        </div>
        </div>
        </div>
        <hr>
        <!-- 센터 필터 버튼 -->
        <div class="d-flex justify-content-between align-items-center my-2">
            
            <div class="btn-group" role="group" id="centerFilterGroup">
            <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="setCenterFilter('ALL')">ALL</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="setCenterFilter('AS')">AS</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="setCenterFilter('AY')">AY</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="setCenterFilter('PG')">PG</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="setCenterFilter('MD')">MD</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="setCenterFilter('GS')">GS</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="setCenterFilter('HN')">HN</button>
          </div>
          <div>
            <input 
              type="text" 
              id="searchInput" 
              placeholder="요청자 또는 Agit 링크로 검색" 
              oninput="handleSearch()"
              class="form-control form-control-sm"
              style="padding: 6px 10px; width: 300px; border: 1px solid #ccc; border-radius: 4px;"
            >
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center my-2">

        <div class="btn-group" role="group" id="statusFilterGroup">
          <button type="button" class="btn btn-sm btn-outline-secondary filter-btn active" onclick="setStatusFilter('ALL')">ALL</button>
          <button type="button" class="btn btn-sm btn-outline-secondary filter-btn" onclick="setStatusFilter('요청')">요청</button>
          <button type="button" class="btn btn-sm btn-outline-secondary filter-btn" onclick="setStatusFilter('진행')">진행</button>
          <button type="button" class="btn btn-sm btn-outline-secondary filter-btn" onclick="setStatusFilter('완료')">완료</button>
        </div>
        <div id="statusSummary" style="margin: 10px 0; font-weight: bold;"></div>
      </div>
          

        

        <hr>
        <div class="table-responsive mt-4">
            <table class="table table-bordered table-hover table-sm align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>진행 상태</th>
                  <th>희망 완료일</th>
                  <th>현재 위치</th>
                  <th>작업 종류</th>
                  <th>작업 내용</th>
                  <th>서버 수</th>
                  <th>벤더</th>
                  <th>요청자</th>
                  <th>Unmount</th>
                  <th>센터 이동 완료</th>
                  <th>작업 파일</th>
                  <th>마운트</th>
                  <th>포설</th>
                  <th>파트 작업</th>
                  <th>OS 설치</th>
                  <th>벤더 이전</th>
                  <th>서버 설정</th>
                  <th>비고</th>
                  <th>Agit Link</th>
                  <th>수정</th>
                  <th>삭제</th>
                </tr>
              </thead>
              <tbody>
                <!-- JS로 렌더링된 행 -->
              </tbody>
            </table>
          </div>
    </div>
    <nav aria-label="페이지네이션" class="d-flex justify-content-center mt-4">
        <ul class="pagination pagination-sm" id="pagination"></ul>
      </nav>
    </div>


    <script>
        ////////////////////////////
        // 전역 상태 & onload
        ////////////////////////////
        let allTasks = [];
        let currentPage = 1;
        const itemsPerPage = 5;  // 페이지당 표시할 작업 수 (원하는 값으로 조절)
        let selectedCenter = "ALL";  // 선택된 센터 필터 (기본은 전체 보기)
        let selectedStatus = "ALL";

        window.onload = () => {
        setCenterFilter("ALL");    // 센터 필터 기본값
        setStatusFilter("ALL");    // 상태 필터 기본값
        fetchAndDisplayTasks();    // 페이지 로드 시 목록 불러오기
        };
        
 
        
        ////////////////////////////
        // 1. 목록 불러오기 + 검색
        ////////////////////////////
        function fetchAndDisplayTasks() {
            fetch("/api/tasks")
                .then(res => res.json())
                .then(tasks => {
                    allTasks = tasks;
                    currentPage = 1; // 목록 새로 불러올 때 페이지 1로
                    updateDisplayedTasks(); // 페이지네이션 + 검색어 반영
                })
                .catch(err => {
                    console.error("❌ 작업 목록 불러오기 실패:", err);
                });
        }
        
        // 검색 핸들러
        function handleSearch() {
            currentPage = 1;  // 검색 시 페이지 1부터
            updateDisplayedTasks();
        }
        
        // 검색 + 페이지네이션 반영하여 최종 목록 표시
        function updateDisplayedTasks() {
            const query = document.getElementById("searchInput").value.trim().toLowerCase();
        
            // 1) 검색 & 필터
            const filtered = allTasks.filter(task => {
                const requester = task.requester?.toLowerCase() || "";
                const link = task.agitLink?.toLowerCase() || "";
                const matchesSearch = requester.includes(query) || link.includes(query);
                const matchesCenter = selectedCenter === "ALL" || task.currentLocation === selectedCenter;
                const matchesStatus = selectedStatus === "ALL" || task.status === selectedStatus;
                return matchesSearch && matchesCenter && matchesStatus;
            });

            // 3) 통계 요약 표시
            renderStatusSummary(filtered); 
            renderCenterEmojiStats(filtered);

            // 4) 페이지네이션: currentPage, itemsPerPage 기준
            const start = (currentPage - 1) * itemsPerPage;
            const pageItems = filtered.slice(start, start + itemsPerPage);
        
            // 5) 테이블 렌더
            renderTableRows(pageItems);
        
            // 6) 페이지네이션 버튼 렌더
            renderPagination(filtered.length);

           // 툴팁 활성
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            new bootstrap.Tooltip(el);
            });


        }
        
        ////////////////////////////
        // 2. 페이지네이션
        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const container = document.getElementById("pagination");
            container.innerHTML = "";

            if (totalPages <= 1) return;

            const nav = document.createElement("nav");
            nav.setAttribute("aria-label", "Page navigation");

            const ul = document.createElement("ul");
            ul.className = "pagination justify-content-center";

            const createPageItem = (label, page, disabled = false, active = false) => {
                const li = document.createElement("li");
                li.className = "page-item";
                if (disabled) li.classList.add("disabled");
                if (active) li.classList.add("active");

                const a = document.createElement("a");
                a.className = "page-link";
                a.href = "#";
                a.innerText = label;
                if (!disabled) {
                    a.onclick = (e) => {
                        e.preventDefault();
                        currentPage = page;
                        updateDisplayedTasks();
                    };
                }
                li.appendChild(a);
                return li;
            };

            // Previous
            ul.appendChild(createPageItem("Previous", currentPage - 1, currentPage === 1));

            const range = 2;
            const pageRange = [];
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - range && i <= currentPage + range)) {
                    pageRange.push(i);
                } else if (pageRange[pageRange.length - 1] !== "...") {
                    pageRange.push("...");
                }
            }

            pageRange.forEach(p => {
                if (p === "...") {
                    const li = document.createElement("li");
                    li.className = "page-item disabled";
                    const span = document.createElement("span");
                    span.className = "page-link";
                    span.innerText = "...";
                    li.appendChild(span);
                    ul.appendChild(li);
                } else {
                    ul.appendChild(createPageItem(p, p, false, p === currentPage));
                }
            });

            // Next
            ul.appendChild(createPageItem("Next", currentPage + 1, currentPage === totalPages));

            nav.appendChild(ul);
            container.appendChild(nav);
        }


        
        ////////////////////////////
        // 3. 테이블 렌더링 
        ////////////////////////////
        function renderTableRows(taskArray) {
            const table = document.querySelector("table");
            let tableBody = table.querySelector("tbody");

  

            if (!tableBody) {
                tableBody = document.createElement("tbody");
                table.appendChild(tableBody);
            }
            tableBody.innerHTML = "";

            taskArray.forEach(task => {
                const row = document.createElement("tr");

                // 상태 표시용 클래스
                const statusLabel = task.status || "요청";
                let statusClass = "btn btn-warning";
                if (statusLabel === "진행") statusClass = "btn-success";
                else if (statusLabel === "완료") statusClass = "btn-dark";

                // 마감일에 따라 색상 줄 추가
                if (statusLabel === "완료") {
                    row.classList.add("table-secondary");
                } else if (task.dueDate) {
                    const diffDays = Math.floor((new Date(task.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (diffDays <= 7) row.classList.add("table-danger");
                    else if (diffDays <= 14) row.classList.add("table-warning");
                    else if (diffDays <= 21) row.classList.add("table-info");
                }

                let locationClass = "btn-secondary"; // 현재위치 버튼 색상 구현

                if (task.migrationType === "external") {
                    const [from, to] = task.center.split(" → ");
                    locationClass = task.currentLocation === from ? "btn-primary" : "btn-secondary";
                }

                row.innerHTML = `
                    <td>
                        <button 
                            onclick="toggleStatus('${task._id}', '${statusLabel}')"
                            class="btn btn-sm ${statusClass}"
                            title="상태 변경">
                            ${statusLabel}
                        </button>
                    </td>
                    <td>${task.dueDate || "-"}</td>
                    <td>
                        <button 
                            class="btn btn-sm ${locationClass}"
                            onclick="toggleLocation('${task._id}', '${task.currentLocation}', '${task.center}', '${task.migrationType}')"
                            title="위치 변경">
                            ${task.currentLocation}
                        </button>
                    </td>
                    <td>${task.migrationType === "external" ? "센터 간 이전" : "내부 이전"}</td>
                    <td>${task.center}</td>
                    <td>${task.serverCount}</td>
                    <td>${task.vendor}</td>
                    <td>${task.requester}</td>
                    <td>${renderCheckbox(task.unmount, task._id, 'unmount')}</td>
                    <td>${renderCheckbox(task.centerMoved, task._id, 'centerMoved')}</td>
                    <td>${renderCheckbox(task.workFile, task._id, 'workFile')}</td>
                    <td>${renderCheckbox(task.mount, task._id, 'mount')}</td>
                    <td>${renderCheckbox(task.cabling, task._id, 'cabling')}</td>
                    <td>${renderCustomCheckbox(task._id, 'partWork', task.partWork)}</td>
                    <td>${renderCustomCheckbox(task._id, 'reinstallOS', task.reinstallOS)}</td>
                    <td>${task.vendorMigration ? "O" : "✖"}</td>
                    <td>${renderCustomCheckbox(task._id, 'serverConfig', task.serverConfig)}</td>
                    <td>
                    ${task.memo
                        ? `<span data-bs-toggle="tooltip" title="${task.memo}" style="cursor: help;">⁉️</span>`
                        : ""}
                    </td>

                    <td>
                        ${task.agitLink 
                            ? `<a href="${task.agitLink}" target="_blank" title="${task.agitLink}">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>` 
                            : ""}
                    </td>

                    <td>
                        <button class="btn btn-light btn-sm" onclick="editTask('${task._id}')">✏️</button>
                    </td>
                    <td>
                        <button class="btn btn-light btn-sm" onclick="deleteTask('${task._id}')">🗑️</button>
                    </td>
                `;
                tableBody.appendChild(row);

                
            });
        }

        function toggleMemo(button) {
            const content = button.nextElementSibling;
            content.classList.toggle("d-none");
        }

        
        ////////////////////////////
        // 4. 체크박스 (true/false)
        ////////////////////////////
        function renderCheckbox(checked, id, field) {
            return `<input type="checkbox" ${checked ? "checked" : ""} 
                           onclick="toggleCheckbox(this, '${id}', '${field}')"/>`;
        }
        
        function toggleCheckbox(checkbox, id, field) {
            const checked = checkbox.checked;
            fetch(`/api/tasks/${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ [field]: checked })
            })
            .then(res => res.json())
            .then(result => {
                if (!result?.success) {
                    alert("❌ 상태 업데이트 실패");
                    checkbox.checked = !checked;
                }
            })
            .catch(err => {
                alert("⚠️ 서버 오류");
                checkbox.checked = !checked;
            });
        }
        
        ////////////////////////////
        // 5. 커스텀 체크박스 (✖ / checked / unchecked)
        ////////////////////////////
        function renderCustomCheckbox(id, field, value) {
            if (value === "✖") return "✖";
            const isChecked = value === "checked" ? "checked" : "";
            return `<input type="checkbox" ${isChecked} 
                           onclick="toggleCustomCheckbox(this, '${id}', '${field}')"/>`;
        }
        
        function toggleCustomCheckbox(checkbox, id, field) {
            const newValue = checkbox.checked ? "checked" : "unchecked";
            fetch(`/api/tasks/${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ [field]: newValue })
            })
            .then(res => res.json())
            .then(result => {
                if (!result?.success) {
                    alert("❌ 상태 반영 실패");
                    checkbox.checked = !checkbox.checked;
                }
            })
            .catch(err => {
                alert("⚠️ 서버 오류");
                checkbox.checked = !checkbox.checked;
            });
        }
        
        ////////////////////////////
        // 6. 상태 변경 (요청 → 진행 → 완료)
        ////////////////////////////
        function toggleStatus(id, currentStatus) {
            const nextStatus =
                currentStatus === "요청" ? "진행" :
                currentStatus === "진행" ? "완료" : "요청";

            fetch(`/api/tasks/${id}/status`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: nextStatus })
            })
            .then(async res => {
                const result = await res.json();
                if (res.ok) {
                    const target = allTasks.find(t => t._id === id);
                    if (target) target.status = nextStatus;
                    updateDisplayedTasks();
                } else {
                    alert("❌ 상태 업데이트 실패: " + (result.error || "서버 오류"));
                }
            })
            .catch(err => {
                console.error("상태 변경 오류:", err);
                alert("⚠️ 상태 변경 중 오류 발생");
            });
        }



        
        ////////////////////////////
        // 7. 위치 토글 (from↔to)
        ////////////////////////////
        function toggleLocation(id, currentLocation, center, migrationType) {
            if (migrationType === "internal") return;

            const [from, to] = center.split(" → ");
            const newLocation = currentLocation === from ? to : from;

            fetch(`/api/tasks/${id}/location`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ currentLocation: newLocation })
            })
            .then(async res => {
                const result = await res.json();
                if (res.ok) {
                    // 👉 allTasks에서 해당 항목 찾아 위치만 바꾸기
                    const target = allTasks.find(t => t._id === id);
                    if (target) target.currentLocation = newLocation;
                    updateDisplayedTasks();
                } else {
                    alert("❌ 위치 업데이트 실패: " + (result.error || "서버 오류"));
                }
            })
            .catch(err => {
                console.error("위치 변경 오류:", err);
                alert("⚠️ 위치 변경 중 오류");
            });
        }


        
        ////////////////////////////
        // 8. 등록/수정/삭제
        ////////////////////////////
        async function saveTask() {
            if (!validateForm()) return;
            const data = collectFormData();
        
            try {
                const res = await fetch("/api/tasks", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    alert("✅ 저장 완료!");
                    resetForm();
                    await fetchAndDisplayTasks(); // 새 목록 반영
                    
                } else {
                    alert("❌ 저장 실패: " + result.error);
                }
            } catch (error) {
                console.error("에러 발생:", error);
                alert("⚠️ 네트워크 오류");
            }
        }
        
        async function updateTask(id) {
            if (!validateForm()) return;

            const existingTask = allTasks.find(t => t._id === id); // 기존 값 찾기
            const data = collectFormData(existingTask); // 기존값 전달

            try {
                const res = await fetch(`/api/tasks/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                await res.json();
                alert("✅ 수정 완료");
                resetForm();
                await fetchAndDisplayTasks();
                const btn = document.getElementById("saveTaskButton");
                btn.textContent = "SAVE";
                btn.onclick = saveTask;
            } catch (err) {
                console.error(err);
                alert("❌ 수정 실패");
            }
        }


        
        async function deleteTask(id) {
            const confirmDelete = confirm("정말 삭제하시겠습니까?");
            if (!confirmDelete) return;
        
            try {
                const res = await fetch(`/api/tasks/${id}`, {
                    method: "DELETE"
                });
                const result = await res.json();
                if (res.ok) {
                    alert("🗑️ 삭제 완료!");
                    await fetchAndDisplayTasks();
                } else {
                    alert("❌ 삭제 실패: " + result.error);
                }
            } catch (err) {
                console.error("삭제 오류:", err);
                alert("⚠️ 서버 오류로 삭제 실패");
            }
        }
        
        ////////////////////////////
        // 9. 수정 모드 (editTask)
        ////////////////////////////
        async function editTask(id) {
            try {
                const res = await fetch(`/api/tasks`);
                const data = await res.json();
                const task = data.find(t => t._id === id);
                if (!task) return alert("작업을 찾을 수 없습니다.");
        
                document.getElementById("migrationType").value = task.migrationType;
                toggleCenterSelect();
        
                if (task.migrationType === "external") {
                    const [from, to] = task.center.split(" → ");
                    document.getElementById("fromCenter").value = from;
                    document.getElementById("toCenter").value = to;
                } else {
                    const [c] = task.center.split(" → ");
                    document.getElementById("internalCenter").value = c;
                }
        
                document.getElementById("vendor").value = task.vendor;
                document.getElementById("serverCount").value = task.serverCount;
                document.getElementById("requester").value = task.requester;
                document.getElementById("dueDate").value = task.dueDate;
                document.getElementById("partWork").checked = !(task.partWork === "✖");
                document.getElementById("osInstall").checked = !(task.reinstallOS === "✖");
                document.getElementById("serverConfig").checked = !(task.serverConfig === "✖");
                document.getElementById("vendorMigration").checked = !!task.vendorMigration;
                document.getElementById("memo").value = task.memo;
                document.getElementById("agitLink").value = task.agitLink;
                // 일반 체크박스 필드들 반영
                document.getElementById("centerMoved").checked    = task.centerMoved;
                document.getElementById("workFile").checked       = task.workFile;
                document.getElementById("mount").checked          = task.mount;
                document.getElementById("cabling").checked        = task.cabling;
                document.getElementById("unmount").checked        = task.unmount;
                // 저장 버튼을 UPDATE 모드로 전환
                const saveBtn = document.getElementById("saveTaskButton");
                saveBtn.textContent = "UPDATE";
                saveBtn.onclick = () => updateTask(id);
        
                document.getElementById("cancelBtn").style.display = "inline-block";
                document.getElementById("resetBtn").style.display = "none";
            } catch (err) {
                console.error(err);
                alert("❌ 수정 모드 진입 실패");
            }
        }
        
        function cancelEdit() {
            resetForm();
            document.getElementById("cancelBtn").style.display = "none";
        }
        
        ////////////////////////////
        // 10. 폼 & 유효성 검사
        ////////////////////////////
        function collectFormData(existingTask = null) {
            const migrationType = document.getElementById("migrationType").value;
            const vendor = document.getElementById("vendor").value;
            const serverCount = document.getElementById("serverCount").value;
            const requester = document.getElementById("requester").value;
            const dueDate = document.getElementById("dueDate").value;
            const memo = document.getElementById("memo").value;
            const agitLink = document.getElementById("agitLink").value;

            let partWork = "✖";
            let reinstallOS = "✖";
            let serverConfig = "✖";
            const vendorMigration = document.getElementById("vendorMigration").checked;

            if (existingTask) {
                // 기존 값이 ✖인 경우 유지
                partWork = existingTask.partWork === "✖" ? "✖" : (document.getElementById("partWork").checked ? "checked" : "unchecked");
                reinstallOS = existingTask.reinstallOS === "✖" ? "✖" : (document.getElementById("osInstall").checked ? "checked" : "unchecked");
                serverConfig = existingTask.serverConfig === "✖" ? "✖" : (document.getElementById("serverConfig").checked ? "checked" : "unchecked");
            } else {
                partWork = document.getElementById("partWork").checked ? "unchecked" : "✖";
                reinstallOS = document.getElementById("osInstall").checked ? "unchecked" : "✖";
                serverConfig = document.getElementById("serverConfig").checked ? "unchecked" : "✖";
            }

            // 일반 체크박스 필드들 - DOM에서 직접 읽기 
            let centerMoved    = document.getElementById("centerMoved").checked;
            let workFile       = document.getElementById("workFile").checked;
            let mount          = document.getElementById("mount").checked;
            let cabling        = document.getElementById("cabling").checked;
            let unmount        = document.getElementById("unmount").checked;

            // 센터와 현재 위치
            let center = "";
            let currentLocation = "";
            if (migrationType === "external") {
                const from = document.getElementById("fromCenter").value;
                const to = document.getElementById("toCenter").value;
                center = `${from} → ${to}`;
                currentLocation = from;
            } else if (migrationType === "internal") {
                const internal = document.getElementById("internalCenter").value;
                center = `${internal} → ${internal}`;
                currentLocation = internal;
            }

            return {
                migrationType, center, currentLocation, vendor, serverCount, requester,
                dueDate, partWork, reinstallOS, memo, agitLink,
                centerMoved, workFile, mount, cabling, vendorMigration, serverConfig, unmount
            };
        }



        
        function validateForm() {
            const migrationType = document.getElementById("migrationType").value;
            const fromCenter = document.getElementById("fromCenter").value;
            const toCenter = document.getElementById("toCenter").value;
            const internalCenter = document.getElementById("internalCenter").value;
            const vendor = document.getElementById("vendor").value;
            const serverCount = document.getElementById("serverCount").value;
            const requester = document.getElementById("requester").value;
        
            if (!migrationType) {
                alert("서버 이전 종류를 선택해주세요.");
                return false;
            }
            if (document.getElementById("vendor").selectedIndex === 0) {
                alert("벤더를 선택해주세요.");
                return false;
            }
            if (migrationType === "external") {
                if (document.getElementById("fromCenter").selectedIndex === 0 ||
                    document.getElementById("toCenter").selectedIndex === 0) {
                    alert("출발 센터와 도착 센터를 모두 선택해주세요.");
                    return false;
                }
            }
            if (migrationType === "internal") {
                if (!internalCenter) {
                    alert("내부 이전 센터를 선택해주세요.");
                    return false;
                }
            }
            if (!serverCount || serverCount <= 0) {
                alert("서버 수를 입력해주세요.");
                return false;
            }
            if (!requester) {
                alert("작업 요청자를 입력해주세요.");
                return false;
            }
            return true;
        }
        
        ////////////////////////////
        // 11. 폼 초기화 + toggle
        ////////////////////////////
        function resetForm() {
            document.getElementById("migrationType").value = "";
            document.getElementById("vendor").value = "";
            document.getElementById("fromCenter").value = "";
            document.getElementById("toCenter").value = "";
            document.getElementById("internalCenter").value = "";
            document.getElementById("serverCount").value = "";
            document.getElementById("requester").value = "";
            document.getElementById("dueDate").value = "";
            document.getElementById("partWork").checked = false;
            document.getElementById("osInstall").checked = false;
            document.getElementById("vendorMigration").checked = false;
            document.getElementById("serverConfig").checked = false;
            document.getElementById("memo").value = "";
            document.getElementById("agitLink").value = "";
            document.getElementById("searchInput").value = "";
        
            toggleCenterSelect();
        
            const saveBtn = document.getElementById("saveTaskButton");
            saveBtn.textContent = "SAVE";
            saveBtn.onclick = saveTask;
        
            document.getElementById("cancelBtn").style.display = "none";
            document.getElementById("resetBtn").style.display = "inline-block";
        }
        
        function toggleCenterSelect() {
            const type = document.getElementById("migrationType").value;
            const centerSection = document.getElementById("centerSelectSection");
            const internalSection = document.getElementById("internalCenterSection");

            if (type === "external") {
                centerSection.classList.remove("d-none");
                internalSection.classList.add("d-none");
            } else if (type === "internal") {
                internalSection.classList.remove("d-none");
                centerSection.classList.add("d-none");
            } else {
                centerSection.classList.add("d-none");
                internalSection.classList.add("d-none");
            }
        }

        
        ////////////////////////////
        // 12. 필터링
        ////////////////////////////
        function filterByCenter(center) {
            selectedCenter = center;
            currentPage = 1;
            updateDisplayedTasks();
        }

        function filterByStatus(status) {
            selectedStatus = status;
            currentPage = 1;

            document.querySelectorAll('#statusFilter button').forEach(btn => {
                btn.classList.remove("active-status");
                if (btn.getAttribute("data-status") === status) {
                    btn.classList.add("active-status");
                }
            });

            updateDisplayedTasks();
        }

        function setCenterFilter(center) {
            selectedCenter = center;
            updateDisplayedTasks();
            highlightActiveFilter("center", center);
        }

        function setStatusFilter(status) {
            selectedStatus = status;
            updateDisplayedTasks();
            highlightActiveFilter("status", status);
        }

        function highlightActiveFilter(type, selectedValue) {
            const allBtns = document.querySelectorAll(`.filter-btn`);
            allBtns.forEach(btn => {
                // 센터 필터인지 상태 필터인지 구분
                const isCenter = btn.onclick?.toString().includes('setCenterFilter');
                const isStatus = btn.onclick?.toString().includes('setStatusFilter');

                if (
                    (type === "center" && isCenter && btn.textContent === selectedValue) ||
                    (type === "status" && isStatus && btn.textContent === selectedValue)
                ) {
                    btn.classList.add("active");
                } else if ((type === "center" && isCenter) || (type === "status" && isStatus)) {
                    btn.classList.remove("active");
                }
            });
        }

        ////////////////////////////
        // 13. 통계
        ////////////////////////////
        function renderStatusSummary(filteredTasks) {
            const total = filteredTasks.length;
            const countByStatus = {
                요청: 0,
                진행: 0,
                완료: 0
            };

            filteredTasks.forEach(task => {
                const status = task.status || "요청";
                countByStatus[status] = (countByStatus[status] || 0) + 1;
            });

            const label = selectedCenter === "ALL" ? "전체" : `${selectedCenter}`;
            const summaryText = `[ 🏢 ${label} ] 전체: ${total} / 요청: ${countByStatus["요청"]} / 진행: ${countByStatus["진행"]} / 완료: ${countByStatus["완료"]}`;

            document.getElementById("statusSummary").textContent = summaryText;
        }

        //이모지 통계
        function renderCenterEmojiStats(filteredTasks) {
            const centerMap = {  AS: 0, AY: 0, PG: 0, MD: 0, GS: 0, HN: 0 };

            filteredTasks.forEach(task => {
                const location = task.currentLocation;
                const count = Number(task.serverCount) || 0;
                if (centerMap.hasOwnProperty(location)) {
                    centerMap[location] += count;
                }
            });

            const container = document.getElementById("centerEmojiStats");
            container.innerHTML = "";

            for (const center in centerMap) {
                const emojiCount = Math.ceil(centerMap[center] / 10);
                const emojis = "😢".repeat(emojiCount);
                container.innerHTML += `<div><strong>${center}:</strong> ${emojis}</div>`;
            }
        }
       
        function renderCenterEmojiStats(filteredTasks) {
        const centerMap = { AS: 0, AY: 0, PG: 0, MD: 0, GS: 0, HN: 0 };
        let totalServers = 0;

        filteredTasks.forEach(task => {
            const location = task.currentLocation;
            const count = Number(task.serverCount) || 0;
            if (centerMap.hasOwnProperty(location)) {
                centerMap[location] += count;
                totalServers += count;
            }
        });

        const container = document.getElementById("centerProgressStats");
        const totalDisplay = document.getElementById("totalServerCount");
        container.innerHTML = "";

        for (const center in centerMap) {
            const widthPx = centerMap[center] * 4; // 1대당 5px 너비
            container.innerHTML += `
                    <div class="mb-2">
            <div class="d-flex justify-content-between">
                <strong>${center}</strong>
                <small>${centerMap[center]}대</small>
            </div>
            <div class="progress" style="height: 24px; background-color: #e9ecef;">
                <div class="progress-bar bg-info text-start ps-2 fw-bold" role="progressbar" style="width: ${widthPx}px">
                    
                    </div>
                </div>
            </div>
            `;
        }

        totalDisplay.textContent = `총 서버 수: ${totalServers}대`;
    }
       
        </script>
<script src="assets/js/bootstrap.bundle.min.js"></script>

</body>
</html>

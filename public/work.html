<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÑúÎ≤Ñ Ïù¥Ï†Ñ Î¶¨Ïä§Ìä∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .box {
            display: inline-block;      
            width: fit-content;         
            max-width: 100%;            
            border: 2px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            margin: 0 auto 20px auto;
            background: #fff;
        }

        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        th {
            background: #ddd;
        }
        .status-progress {
            background-color: yellow;
        }
        .status-working {
            background-color: red;
            color: white;
        }
        .status-complete {
            background-color: gray;
            color: white;
        }
        .small-input {
            width: 70px;
        }
        select option[disabled] {
            color: gray;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-top: 0;  
            margin-bottom: 15px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            color: #333;
        }
        .inline-group {
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        .middle-input {
            width: 80px;
        }
        .link-input {
            width: 500px;
        }
        .status-default {
            background-color: white;
            color: black;
        }

        .status-working {
            background-color: green;
            color: white;
        }

        .status-complete {
            background-color: black;
            color: white;
        }
        .status-btn {
            border: none;
            padding: 6px 12px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
        }

        .status-default {
            background-color: white;
            color: black;
            border: 1px solid #ccc;
        }

        .status-working {
            background-color: green;
            color: white;
        }

        .status-complete {
            background-color: black;
            color: white;
        }
        .urgent-1week {
            background-color: #ffe5e5 !important;
        }
        .urgent-2week {
            background-color: #fff7d9 !important;
        }
        .urgent-3week {
            background-color: #ecf9ff !important;
        }
        .completed-row { 
            background-color: #e0e0e0 !important; 
        }
        .pagination-btn {
            margin: 0 3px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            cursor: pointer;
        }
        .pagination-btn.active {
            font-weight: bold;
            background: #ddd;
        }
        #centerFilter button {
            padding: 5px 12px;
            margin-right: 6px;
            border: 1px solid #ccc;
            background: #f4f4f4;
            border-radius: 4px;
            cursor: pointer;
        }
        #centerFilter button:hover {
            background: #ddd;
        }
        .filter-btn {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background: #f0f0f0;
        cursor: pointer;
        border-radius: 5px;
        margin-right: 6px;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            font-weight: bold;
            border-color: #007bff;
        }


    </style>
</head>
<body>
    <div class="container">
        <div class="header">Kakao IDC team ÏÑúÎ≤Ñ Ïù¥Ï†Ñ Î¶¨Ïä§Ìä∏</div>
        <!-- ÏÑºÌÑ∞ ÌïÑÌÑ∞ Î≤ÑÌäº -->
        <div style="margin-bottom: 10px;">
            <span><strong>ÏÑºÌÑ∞:</strong></span>
            <button class="filter-btn" onclick="setCenterFilter('ALL')">ALL</button>
            <button class="filter-btn" onclick="setCenterFilter('AS')">AS</button>
            <button class="filter-btn" onclick="setCenterFilter('AY')">AY</button>
            <button class="filter-btn" onclick="setCenterFilter('PG')">PG</button>
            <button class="filter-btn" onclick="setCenterFilter('MD')">MD</button>
            <button class="filter-btn" onclick="setCenterFilter('GS')">GS</button>
            <button class="filter-btn" onclick="setCenterFilter('HN')">HN</button>
        </div>
  
        <div class="container" ;>
        <div class="box">
            <p class="section-title">ÏûëÏóÖ Îì±Î°ù</p>
            <div class="inline-group">
                <label>ÏÑúÎ≤Ñ Ïù¥Ï†Ñ Ï¢ÖÎ•ò: </label>  
                <select id="migrationType" onchange="toggleCenterSelect()">
                    <option value="" disabled selected>ÏûëÏóÖ Ï¢ÖÎ•ò ÏÑ†ÌÉù</option>
                    <option value="external">ÏÑºÌÑ∞ Í∞Ñ Ïù¥Ï†Ñ</option>
                    <option value="internal">ÎÇ¥Î∂Ä Ïù¥Ï†Ñ</option>
                </select>
            </div>
            <div id="centerSelectSection" class="inline-group" style="display: none;">
                <label>ÏÑºÌÑ∞ Í∞Ñ Ïù¥Ï†Ñ: </label>
                <select id="fromCenter">
                    <option value="" disabled selected>Ï∂úÎ∞ú ÏÑºÌÑ∞</option>
                    <option>AS</option>
                    <option>AY</option>
                    <option>PG</option>
                    <option>MD</option>
                    <option>GS</option>
                    <option>HN</option>
                </select>
                &nbsp;to&nbsp;
                <select id="toCenter">
                    <option value="" disabled selected>ÎèÑÏ∞© ÏÑºÌÑ∞</option>
                    <option>AS</option>
                    <option>AY</option>
                    <option>PG</option>
                    <option>MD</option>
                    <option>GS</option>
                    <option>HN</option>
                </select>
            </div>
            <div id="internalCenterSection" class="inline-group" style="display: none;">
                <label>ÏûëÏóÖ ÏÑºÌÑ∞: </label>
                <select id="internalCenter">
                    <option value="" disabled selected>ÏÑºÌÑ∞ ÏÑ†ÌÉù</option>
                    <option>AS</option>
                    <option>AY</option>
                    <option>PG</option>
                    <option>MD</option>
                    <option>GS</option>
                    <option>HN</option>
                </select>
            </div>
            <br><br>
            <label>Î≤§Îçî: </label> <select id="vendor">
                <option value="" disabled selected>Î≤§Îçî ÏÑ†ÌÉù</option>
                <option value="kaytus">KAYTUS</option>
                <option value="xfusion">XFUSION</option>
                <option value="others">Í∑∏ Ïô∏</option>
                <option value="mixed">Î≥µÌï©</option>
            </select> &nbsp;
            <label>ÏÑúÎ≤Ñ Ïàò: </label><input id="serverCount" class="small-input" type="number" min="0" placeholder=" Ex)10"> &nbsp;
            <label>ÏöîÏ≤≠Ïûê: </label><input id="requester" class="middle-input" type="text" placeholder=" EX) gnar"> &nbsp;
            <label>Ìù¨Îßù ÏôÑÎ£åÏùº: </label><input id="dueDate" type="date"> &nbsp;
            <label>ÌååÌä∏ ÏûëÏóÖ Ïó¨Î∂Ä: <input id="partWork" type="checkbox"></label>
            <label>OS Ïû¨ÏÑ§Ïπò Ïó¨Î∂Ä: <input id="osInstall" type="checkbox"></label>
            <br><br>
            <label>ÎπÑÍ≥†: </label><textarea id="memo" rows="1" cols="50"></textarea>
            <br><br>
            <label>Agit Link: </label><input id="agitLink" class="link-input" type="text" placeholder="ÎßÅÌÅ¨Î•º ÌÜµÌïòÏó¨ Í≤ÄÏÉâÎêòÎãà Ï†ïÌôïÌûà ÏûÖÎ†•Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§."> 
            <button id="saveTaskButton" onclick="saveTask()">SAVE</button>
            <button id="resetBtn" onclick="resetForm()">Ï¥àÍ∏∞Ìôî</button>
            <button id="cancelBtn" onclick="cancelEdit()" style="display: none;">Ï∑®ÏÜå</button>
            
            <!-- Ïà®Í≤®ÏßÑ ÏùºÎ∞ò Ï≤¥ÌÅ¨Î∞ïÏä§ ÌïÑÎìúÎì§ (ÏàòÏ†ïÏö© ÏÉÅÌÉú Î≥¥Ï°¥Ïö©) -->
            <input type="checkbox" id="centerMoved" style="display:none;">
            <input type="checkbox" id="workFile" style="display:none;">
            <input type="checkbox" id="mount" style="display:none;">
            <input type="checkbox" id="cabling" style="display:none;">
            <input type="checkbox" id="serverConfig" style="display:none;">
            <input type="checkbox" id="partReturn" style="display:none;">
            <input type="checkbox" id="unmount" style="display:none;">

        </div>
    </div>

        <div style="margin-bottom: 10px;">
            <span><strong>ÏßÑÌñâ ÏÉÅÌÉú:</strong></span>
            <button class="filter-btn" onclick="setStatusFilter('ALL')">ALL</button>
            <button class="filter-btn" onclick="setStatusFilter('ÏßÑÌñâÏ†Ñ')">ÏßÑÌñâÏ†Ñ</button>
            <button class="filter-btn" onclick="setStatusFilter('ÏûëÏóÖÏ§ë')">ÏûëÏóÖÏ§ë</button>
            <button class="filter-btn" onclick="setStatusFilter('ÏôÑÎ£å')">ÏôÑÎ£å</button>
        </div>
          
        <div style="margin-bottom: 10px;">
            üîç <input 
                type="text" 
                id="searchInput" 
                placeholder="ÏöîÏ≤≠Ïûê ÎòêÎäî Agit ÎßÅÌÅ¨Î°ú Í≤ÄÏÉâ" 
                oninput="handleSearch()"
                style="padding: 6px 10px; width: 300px; border: 1px solid #ccc; border-radius: 4px;"
            >
        </div>

        <div id="statusSummary" style="margin: 10px 0; font-weight: bold;"></div>


        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ÏßÑÌñâ ÏÉÅÌÉú</th>                       
                        <th>Ìù¨Îßù ÏôÑÎ£åÏùº</th>
                        <th>ÌòÑÏû¨ ÏúÑÏπò</th>
                        <th>ÏûëÏóÖ Ï¢ÖÎ•ò</th>
                        <th>ÏûëÏóÖ ÎÇ¥Ïö©</th>
                        <th>ÏÑúÎ≤Ñ Ïàò</th>
                        <th>Î≤§Îçî</th>
                        <th>ÏöîÏ≤≠Ïûê</th>
                        <th>unmount</th>
                        <th>ÏÑºÌÑ∞ Ïù¥Îèô ÏôÑÎ£å</th>
                        <th>ÏûëÏóÖ ÌååÏùº</th>
                        <th>ÎßàÏö¥Ìä∏</th>
                        <th>Ìè¨ÏÑ§</th>
                        <th>ÌååÌä∏ ÏûëÏóÖ</th>
                        <th>OS ÏÑ§Ïπò</th>
                        <th>ÏÑúÎ≤Ñ ÏÑ§Ï†ï</th>
                        <th>ÌååÌä∏ Î∞òÎÇ©</th>
                        <th>ÎπÑÍ≥†</th>
                        <th>Agit link</th>
                        <th>Í¥ÄÎ¶¨</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <div id="pagination" style="margin-top: 20px; text-align: center;"></div>
    </div>


    <script>
        ////////////////////////////
        // Ï†ÑÏó≠ ÏÉÅÌÉú & onload
        ////////////////////////////
        let allTasks = [];
        let currentPage = 1;
        const itemsPerPage = 20;  // ÌéòÏù¥ÏßÄÎãπ ÌëúÏãúÌï† ÏûëÏóÖ Ïàò (ÏõêÌïòÎäî Í∞íÏúºÎ°ú Ï°∞Ï†à)
        let selectedCenter = "ALL";  // ÏÑ†ÌÉùÎêú ÏÑºÌÑ∞ ÌïÑÌÑ∞ (Í∏∞Î≥∏ÏùÄ Ï†ÑÏ≤¥ Î≥¥Í∏∞)
        let selectedStatus = "ALL";

        
        window.onload = fetchAndDisplayTasks; // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
        
        ////////////////////////////
        // 1. Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ + Í≤ÄÏÉâ
        ////////////////////////////
        function fetchAndDisplayTasks() {
            fetch("/api/tasks")
                .then(res => res.json())
                .then(tasks => {
                    allTasks = tasks;
                    currentPage = 1; // Î™©Î°ù ÏÉàÎ°ú Î∂àÎü¨Ïò¨ Îïå ÌéòÏù¥ÏßÄ 1Î°ú
                    updateDisplayedTasks(); // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò + Í≤ÄÏÉâÏñ¥ Î∞òÏòÅ
                })
                .catch(err => {
                    console.error("‚ùå ÏûëÏóÖ Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err);
                });
        }
        
        // Í≤ÄÏÉâ Ìï∏Îì§Îü¨
        function handleSearch() {
            currentPage = 1;  // Í≤ÄÏÉâ Ïãú ÌéòÏù¥ÏßÄ 1Î∂ÄÌÑ∞
            updateDisplayedTasks();
        }
        
        // Í≤ÄÏÉâ + ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Î∞òÏòÅÌïòÏó¨ ÏµúÏ¢Ö Î™©Î°ù ÌëúÏãú
        function updateDisplayedTasks() {
            const query = document.getElementById("searchInput").value.trim().toLowerCase();
        
            // 1) Í≤ÄÏÉâ & ÌïÑÌÑ∞
            const filtered = allTasks.filter(task => {
                const requester = task.requester?.toLowerCase() || "";
                const link = task.agitLink?.toLowerCase() || "";
                const matchesSearch = requester.includes(query) || link.includes(query);
                const matchesCenter = selectedCenter === "ALL" || task.currentLocation === selectedCenter;
                const matchesStatus = selectedStatus === "ALL" || task.status === selectedStatus;
                return matchesSearch && matchesCenter && matchesStatus;
            });

            // 3) ÌÜµÍ≥Ñ ÏöîÏïΩ ÌëúÏãú
            renderStatusSummary(filtered); 
        
            // 4) ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò: currentPage, itemsPerPage Í∏∞Ï§Ä
            const start = (currentPage - 1) * itemsPerPage;
            const pageItems = filtered.slice(start, start + itemsPerPage);
        
            // 5) ÌÖåÏù¥Î∏î Î†åÎçî
            renderTableRows(pageItems);
        
            // 6) ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Î≤ÑÌäº Î†åÎçî
            renderPagination(filtered.length);
        }
        
        ////////////////////////////
        // 2. ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
        ////////////////////////////
        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const container = document.getElementById("pagination");
            container.innerHTML = "";
        
            // ÌéòÏù¥ÏßÄÍ∞Ä 1Í∞ú Ïù¥ÌïòÎùºÎ©¥ Î≤ÑÌäº ÌëúÏãú Ïïà Ìï®
            if (totalPages <= 1) return;
        
            // Î≤ÑÌäº ÏÉùÏÑ±
            const makeBtn = (label, page) => {
                const btn = document.createElement("button");
                btn.textContent = label;
                btn.className = "pagination-btn";
                if (page === currentPage) btn.classList.add("active");
                btn.onclick = () => {
                    currentPage = page;
                    updateDisplayedTasks();
                };
                return btn;
            };
        
            // Ïù¥Ï†ÑÎ≤ÑÌäº
            if (currentPage > 1) {
                container.appendChild(makeBtn("<", currentPage - 1));
            }
        
            // Ïà´Ïûê Î≤ÑÌäº
            for (let i = 1; i <= totalPages; i++) {
                container.appendChild(makeBtn(i, i));
            }
        
            // Îã§ÏùåÎ≤ÑÌäº
            if (currentPage < totalPages) {
                container.appendChild(makeBtn(">", currentPage + 1));
            }
        }
        
        ////////////////////////////
        // 3. ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ 
        ////////////////////////////
        function renderTableRows(taskArray) {
            const table = document.querySelector("table");
            let tableBody = table.querySelector("tbody");
        
            // tbodyÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
            if (!tableBody) {
                tableBody = document.createElement("tbody");
                table.appendChild(tableBody);
            }
            tableBody.innerHTML = "";
        
            // Í∞Å taskÎßàÎã§ Ìñâ ÏÉùÏÑ±
            taskArray.forEach(task => {
                const row = document.createElement("tr");
        
                // ÏÉÅÌÉú ÌëúÏãú
                const statusLabel = task.status || "ÏßÑÌñâÏ†Ñ";
                let statusClass = "status-default";
                if (statusLabel === "ÏûëÏóÖÏ§ë")      statusClass = "status-working";
                else if (statusLabel === "ÏôÑÎ£å")   statusClass = "status-complete";
        
                // ÎÇ†Ïßú D-day ÌïòÏù¥ÎùºÏù¥Ìä∏
                if (statusLabel === "ÏôÑÎ£å") {
                    row.classList.add("completed-row");
                } else if (task.dueDate) {
                    const diffDays = Math.floor((new Date(task.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (diffDays <= 7)        row.classList.add("urgent-1week");
                    else if (diffDays <= 14)  row.classList.add("urgent-2week");
                    else if (diffDays <= 21)  row.classList.add("urgent-3week");
                }
        
                // Ïã§Ï†ú Ìñâ HTML
                row.innerHTML = `
                    <td>
                        <button 
                            onclick="toggleStatus('${task._id}', '${statusLabel}')" 
                            class="status-btn ${statusClass}" 
                            title="ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÌÉú Î≥ÄÍ≤Ω">
                            ${statusLabel}
                        </button>
                    </td>
                    <td>${task.dueDate || "-"}</td>
                    <td>
                        <button 
                            onclick="toggleLocation('${task._id}', '${task.currentLocation}', '${task.center}', '${task.migrationType}')"
                            title="ÌÅ¥Î¶≠ÌïòÏó¨ ÏúÑÏπò Î≥ÄÍ≤Ω">
                            ${task.currentLocation}
                        </button>
                    </td>
                    <td>${task.migrationType === "external" ? "ÏÑºÌÑ∞ Í∞Ñ Ïù¥Ï†Ñ" : "ÎÇ¥Î∂Ä Ïù¥Ï†Ñ"}</td>
                    <td>${task.center}</td>
                    <td>${task.serverCount}</td>
                    <td>${task.vendor}</td>
                    <td>${task.requester}</td>
                    <td>${renderCheckbox(task.unmount, task._id, 'unmount')}</td>
                    <td>${renderCheckbox(task.centerMoved, task._id, 'centerMoved')}</td>
                    <td>${renderCheckbox(task.workFile, task._id, 'workFile')}</td>
                    <td>${renderCheckbox(task.mount, task._id, 'mount')}</td>
                    <td>${renderCheckbox(task.cabling, task._id, 'cabling')}</td>
                    <td>${renderCustomCheckbox(task._id, 'partWork', task.partWork)}</td>
                    <td>${renderCustomCheckbox(task._id, 'reinstallOS', task.reinstallOS)}</td>
                    <td>${renderCheckbox(task.serverConfig, task._id, 'serverConfig')}</td>
                    <td>${renderCheckbox(task.partReturn, task._id, 'partReturn')}</td>
                    <td>${task.memo || ""}</td>
                    <td><a href="${task.agitLink}" target="_blank">${task.agitLink}</a></td>
                    <td>
                        <button onclick="editTask('${task._id}')">‚úèÔ∏è</button>
                        <button onclick="deleteTask('${task._id}')">üóëÔ∏è</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        ////////////////////////////
        // 4. Ï≤¥ÌÅ¨Î∞ïÏä§ (true/false)
        ////////////////////////////
        function renderCheckbox(checked, id, field) {
            return `<input type="checkbox" ${checked ? "checked" : ""} 
                           onclick="toggleCheckbox(this, '${id}', '${field}')"/>`;
        }
        
        function toggleCheckbox(checkbox, id, field) {
            const checked = checkbox.checked;
            fetch(`/api/tasks/${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ [field]: checked })
            })
            .then(res => res.json())
            .then(result => {
                if (!result?.success) {
                    alert("‚ùå ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®");
                    checkbox.checked = !checked;
                }
            })
            .catch(err => {
                alert("‚ö†Ô∏è ÏÑúÎ≤Ñ Ïò§Î•ò");
                checkbox.checked = !checked;
            });
        }
        
        ////////////////////////////
        // 5. Ïª§Ïä§ÌÖÄ Ï≤¥ÌÅ¨Î∞ïÏä§ (‚úñ / checked / unchecked)
        ////////////////////////////
        function renderCustomCheckbox(id, field, value) {
            if (value === "‚úñ") return "‚úñ";
            const isChecked = value === "checked" ? "checked" : "";
            return `<input type="checkbox" ${isChecked} 
                           onclick="toggleCustomCheckbox(this, '${id}', '${field}')"/>`;
        }
        
        function toggleCustomCheckbox(checkbox, id, field) {
            const newValue = checkbox.checked ? "checked" : "unchecked";
            fetch(`/api/tasks/${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ [field]: newValue })
            })
            .then(res => res.json())
            .then(result => {
                if (!result?.success) {
                    alert("‚ùå ÏÉÅÌÉú Î∞òÏòÅ Ïã§Ìå®");
                    checkbox.checked = !checkbox.checked;
                }
            })
            .catch(err => {
                alert("‚ö†Ô∏è ÏÑúÎ≤Ñ Ïò§Î•ò");
                checkbox.checked = !checkbox.checked;
            });
        }
        
        ////////////////////////////
        // 6. ÏÉÅÌÉú Î≥ÄÍ≤Ω (ÏßÑÌñâÏ†Ñ ‚Üí ÏûëÏóÖÏ§ë ‚Üí ÏôÑÎ£å)
        ////////////////////////////
        function toggleStatus(id, currentStatus) {
            const nextStatus =
                currentStatus === "ÏßÑÌñâÏ†Ñ" ? "ÏûëÏóÖÏ§ë" :
                currentStatus === "ÏûëÏóÖÏ§ë" ? "ÏôÑÎ£å" : "ÏßÑÌñâÏ†Ñ";

            fetch(`/api/tasks/${id}/status`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: nextStatus })
            })
            .then(async res => {
                const result = await res.json();
                if (res.ok) {
                    // üëâ allTasksÏóêÏÑú Ìï¥Îãπ Ìï≠Î™© Ï∞æÏïÑ ÏÉÅÌÉúÎßå Î∞îÎ°ú Î∞îÍæ∏Í∏∞
                    const target = allTasks.find(t => t._id === id);
                    if (target) target.status = nextStatus;
                    updateDisplayedTasks();
                } else {
                    alert("‚ùå ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: " + (result.error || "ÏÑúÎ≤Ñ Ïò§Î•ò"));
                }
            })
            .catch(err => {
                console.error("ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïò§Î•ò:", err);
                alert("‚ö†Ô∏è ÏÉÅÌÉú Î≥ÄÍ≤Ω Ï§ë Ïò§Î•ò Î∞úÏÉù");
            });
        }


        
        ////////////////////////////
        // 7. ÏúÑÏπò ÌÜ†Í∏Ä (from‚Üîto)
        ////////////////////////////
        function toggleLocation(id, currentLocation, center, migrationType) {
            if (migrationType === "internal") return;

            const [from, to] = center.split(" ‚Üí ");
            const newLocation = currentLocation === from ? to : from;

            fetch(`/api/tasks/${id}/location`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ currentLocation: newLocation })
            })
            .then(async res => {
                const result = await res.json();
                if (res.ok) {
                    // üëâ allTasksÏóêÏÑú Ìï¥Îãπ Ìï≠Î™© Ï∞æÏïÑ ÏúÑÏπòÎßå Î∞îÍæ∏Í∏∞
                    const target = allTasks.find(t => t._id === id);
                    if (target) target.currentLocation = newLocation;
                    updateDisplayedTasks();
                } else {
                    alert("‚ùå ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: " + (result.error || "ÏÑúÎ≤Ñ Ïò§Î•ò"));
                }
            })
            .catch(err => {
                console.error("ÏúÑÏπò Î≥ÄÍ≤Ω Ïò§Î•ò:", err);
                alert("‚ö†Ô∏è ÏúÑÏπò Î≥ÄÍ≤Ω Ï§ë Ïò§Î•ò");
            });
        }


        
        ////////////////////////////
        // 8. Îì±Î°ù/ÏàòÏ†ï/ÏÇ≠Ï†ú
        ////////////////////////////
        async function saveTask() {
            if (!validateForm()) return;
            const data = collectFormData();
        
            try {
                const res = await fetch("/api/tasks", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    alert("‚úÖ Ï†ÄÏû• ÏôÑÎ£å!");
                    resetForm();
                    await fetchAndDisplayTasks(); // ÏÉà Î™©Î°ù Î∞òÏòÅ
                } else {
                    alert("‚ùå Ï†ÄÏû• Ïã§Ìå®: " + result.error);
                }
            } catch (error) {
                console.error("ÏóêÎü¨ Î∞úÏÉù:", error);
                alert("‚ö†Ô∏è ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò");
            }
        }
        
        async function updateTask(id) {
            if (!validateForm()) return;

            const existingTask = allTasks.find(t => t._id === id); // Í∏∞Ï°¥ Í∞í Ï∞æÍ∏∞
            const data = collectFormData(existingTask); // Í∏∞Ï°¥Í∞í Ï†ÑÎã¨

            try {
                const res = await fetch(`/api/tasks/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                await res.json();
                alert("‚úÖ ÏàòÏ†ï ÏôÑÎ£å");
                resetForm();
                await fetchAndDisplayTasks();
                const btn = document.getElementById("saveTaskButton");
                btn.textContent = "SAVE";
                btn.onclick = saveTask;
            } catch (err) {
                console.error(err);
                alert("‚ùå ÏàòÏ†ï Ïã§Ìå®");
            }
        }


        
        async function deleteTask(id) {
            const confirmDelete = confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
            if (!confirmDelete) return;
        
            try {
                const res = await fetch(`/api/tasks/${id}`, {
                    method: "DELETE"
                });
                const result = await res.json();
                if (res.ok) {
                    alert("üóëÔ∏è ÏÇ≠Ï†ú ÏôÑÎ£å!");
                    await fetchAndDisplayTasks();
                } else {
                    alert("‚ùå ÏÇ≠Ï†ú Ïã§Ìå®: " + result.error);
                }
            } catch (err) {
                console.error("ÏÇ≠Ï†ú Ïò§Î•ò:", err);
                alert("‚ö†Ô∏è ÏÑúÎ≤Ñ Ïò§Î•òÎ°ú ÏÇ≠Ï†ú Ïã§Ìå®");
            }
        }
        
        ////////////////////////////
        // 9. ÏàòÏ†ï Î™®Îìú (editTask)
        ////////////////////////////
        async function editTask(id) {
            try {
                const res = await fetch(`/api/tasks`);
                const data = await res.json();
                const task = data.find(t => t._id === id);
                if (!task) return alert("ÏûëÏóÖÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
        
                document.getElementById("migrationType").value = task.migrationType;
                toggleCenterSelect();
        
                if (task.migrationType === "external") {
                    const [from, to] = task.center.split(" ‚Üí ");
                    document.getElementById("fromCenter").value = from;
                    document.getElementById("toCenter").value = to;
                } else {
                    const [c] = task.center.split(" ‚Üí ");
                    document.getElementById("internalCenter").value = c;
                }
        
                document.getElementById("vendor").value = task.vendor;
                document.getElementById("serverCount").value = task.serverCount;
                document.getElementById("requester").value = task.requester;
                document.getElementById("dueDate").value = task.dueDate;
                document.getElementById("partWork").checked = !(task.partWork === "‚úñ");
                document.getElementById("osInstall").checked = !(task.reinstallOS === "‚úñ");
                document.getElementById("memo").value = task.memo;
                document.getElementById("agitLink").value = task.agitLink;
                // ÏùºÎ∞ò Ï≤¥ÌÅ¨Î∞ïÏä§ ÌïÑÎìúÎì§ Î∞òÏòÅ
                document.getElementById("centerMoved").checked    = task.centerMoved;
                document.getElementById("workFile").checked       = task.workFile;
                document.getElementById("mount").checked          = task.mount;
                document.getElementById("cabling").checked        = task.cabling;
                document.getElementById("serverConfig").checked   = task.serverConfig;
                document.getElementById("partReturn").checked     = task.partReturn;
                document.getElementById("unmount").checked        = task.unmount;
                // Ï†ÄÏû• Î≤ÑÌäºÏùÑ UPDATE Î™®ÎìúÎ°ú Ï†ÑÌôò
                const saveBtn = document.getElementById("saveTaskButton");
                saveBtn.textContent = "UPDATE";
                saveBtn.onclick = () => updateTask(id);
        
                document.getElementById("cancelBtn").style.display = "inline-block";
                document.getElementById("resetBtn").style.display = "none";
            } catch (err) {
                console.error(err);
                alert("‚ùå ÏàòÏ†ï Î™®Îìú ÏßÑÏûÖ Ïã§Ìå®");
            }
        }
        
        function cancelEdit() {
            resetForm();
            document.getElementById("cancelBtn").style.display = "none";
        }
        
        ////////////////////////////
        // 10. Ìèº & Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
        ////////////////////////////
        function collectFormData(existingTask = null) {
            const migrationType = document.getElementById("migrationType").value;
            const vendor = document.getElementById("vendor").value;
            const serverCount = document.getElementById("serverCount").value;
            const requester = document.getElementById("requester").value;
            const dueDate = document.getElementById("dueDate").value;
            const memo = document.getElementById("memo").value;
            const agitLink = document.getElementById("agitLink").value;

            // ÏÇ¨Ïö©Ïûê Ï†ïÏùò Ï≤¥ÌÅ¨Î∞ïÏä§
            const partWorkChecked = document.getElementById("partWork").checked;
            const osInstallChecked = document.getElementById("osInstall").checked;

            let partWork = partWorkChecked ? "unchecked" : "‚úñ";
            let reinstallOS = osInstallChecked ? "unchecked" : "‚úñ";

            // ÏàòÏ†ï Î™®ÎìúÏóêÏÑúÎäî Í∏∞Ï°¥ Í∞íÏù¥ ‚úñÏù¥Î©¥ Ïú†ÏßÄ
            if (existingTask) {
                if (existingTask.partWork === "‚úñ") partWork = "‚úñ";
                if (existingTask.reinstallOS === "‚úñ") reinstallOS = "‚úñ";
            }

            // ÏùºÎ∞ò Ï≤¥ÌÅ¨Î∞ïÏä§ ÌïÑÎìúÎì§ - DOMÏóêÏÑú ÏßÅÏ†ë ÏùΩÍ∏∞ 
            let centerMoved    = document.getElementById("centerMoved").checked;
            let workFile       = document.getElementById("workFile").checked;
            let mount          = document.getElementById("mount").checked;
            let cabling        = document.getElementById("cabling").checked;
            let serverConfig   = document.getElementById("serverConfig").checked;
            let partReturn     = document.getElementById("partReturn").checked;
            let unmount        = document.getElementById("unmount").checked;

            // ÏÑºÌÑ∞ÏôÄ ÌòÑÏû¨ ÏúÑÏπò
            let center = "";
            let currentLocation = "";
            if (migrationType === "external") {
                const from = document.getElementById("fromCenter").value;
                const to = document.getElementById("toCenter").value;
                center = `${from} ‚Üí ${to}`;
                currentLocation = from;
            } else if (migrationType === "internal") {
                const internal = document.getElementById("internalCenter").value;
                center = `${internal} ‚Üí ${internal}`;
                currentLocation = internal;
            }

            return {
                migrationType, center, currentLocation, vendor, serverCount, requester,
                dueDate, partWork, reinstallOS, memo, agitLink,
                centerMoved, workFile, mount, cabling, serverConfig, partReturn, unmount
            };
        }



        
        function validateForm() {
            const migrationType = document.getElementById("migrationType").value;
            const fromCenter = document.getElementById("fromCenter").value;
            const toCenter = document.getElementById("toCenter").value;
            const internalCenter = document.getElementById("internalCenter").value;
            const vendor = document.getElementById("vendor").value;
            const serverCount = document.getElementById("serverCount").value;
            const requester = document.getElementById("requester").value;
        
            if (!migrationType) {
                alert("ÏÑúÎ≤Ñ Ïù¥Ï†Ñ Ï¢ÖÎ•òÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                return false;
            }
            if (document.getElementById("vendor").selectedIndex === 0) {
                alert("Î≤§ÎçîÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                return false;
            }
            if (migrationType === "external") {
                if (document.getElementById("fromCenter").selectedIndex === 0 ||
                    document.getElementById("toCenter").selectedIndex === 0) {
                    alert("Ï∂úÎ∞ú ÏÑºÌÑ∞ÏôÄ ÎèÑÏ∞© ÏÑºÌÑ∞Î•º Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                    return false;
                }
            }
            if (migrationType === "internal") {
                if (!internalCenter) {
                    alert("ÎÇ¥Î∂Ä Ïù¥Ï†Ñ ÏÑºÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                    return false;
                }
            }
            if (!serverCount || serverCount <= 0) {
                alert("ÏÑúÎ≤Ñ ÏàòÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return false;
            }
            if (!requester) {
                alert("ÏûëÏóÖ ÏöîÏ≤≠ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return false;
            }
            return true;
        }
        
        ////////////////////////////
        // 11. Ìèº Ï¥àÍ∏∞Ìôî + toggle
        ////////////////////////////
        function resetForm() {
            document.getElementById("migrationType").value = "";
            document.getElementById("vendor").value = "";
            document.getElementById("fromCenter").value = "";
            document.getElementById("toCenter").value = "";
            document.getElementById("internalCenter").value = "";
            document.getElementById("serverCount").value = "";
            document.getElementById("requester").value = "";
            document.getElementById("dueDate").value = "";
            document.getElementById("partWork").checked = false;
            document.getElementById("osInstall").checked = false;
            document.getElementById("memo").value = "";
            document.getElementById("agitLink").value = "";
            document.getElementById("searchInput").value = "";
        
            toggleCenterSelect();
        
            const saveBtn = document.getElementById("saveTaskButton");
            saveBtn.textContent = "SAVE";
            saveBtn.onclick = saveTask;
        
            document.getElementById("cancelBtn").style.display = "none";
            document.getElementById("resetBtn").style.display = "inline-block";
        }
        
        function toggleCenterSelect() {
            const type = document.getElementById("migrationType").value;
            document.getElementById("centerSelectSection").style.display = 
                (type === "external") ? "inline-block" : "none";
            document.getElementById("internalCenterSection").style.display = 
                (type === "internal") ? "inline-block" : "none";
        }
        
        ////////////////////////////
        // 12. ÌïÑÌÑ∞ÎßÅ
        ////////////////////////////
        function filterByCenter(center) {
            selectedCenter = center;
            currentPage = 1;
            updateDisplayedTasks();
        }

        function filterByStatus(status) {
            selectedStatus = status;
            currentPage = 1;

            document.querySelectorAll('#statusFilter button').forEach(btn => {
                btn.classList.remove("active-status");
                if (btn.getAttribute("data-status") === status) {
                    btn.classList.add("active-status");
                }
            });

            updateDisplayedTasks();
        }

        function setCenterFilter(center) {
            selectedCenter = center;
            updateDisplayedTasks();
            highlightActiveFilter("center", center);
        }

        function setStatusFilter(status) {
            selectedStatus = status;
            updateDisplayedTasks();
            highlightActiveFilter("status", status);
        }

        function highlightActiveFilter(type, selectedValue) {
            const allBtns = document.querySelectorAll(`.filter-btn`);
            allBtns.forEach(btn => {
                // ÏÑºÌÑ∞ ÌïÑÌÑ∞Ïù∏ÏßÄ ÏÉÅÌÉú ÌïÑÌÑ∞Ïù∏ÏßÄ Íµ¨Î∂Ñ
                const isCenter = btn.onclick?.toString().includes('setCenterFilter');
                const isStatus = btn.onclick?.toString().includes('setStatusFilter');

                if (
                    (type === "center" && isCenter && btn.textContent === selectedValue) ||
                    (type === "status" && isStatus && btn.textContent === selectedValue)
                ) {
                    btn.classList.add("active");
                } else if ((type === "center" && isCenter) || (type === "status" && isStatus)) {
                    btn.classList.remove("active");
                }
            });
        }

        ////////////////////////////
        // 13. ÌÜµÍ≥Ñ
        ////////////////////////////
        function renderStatusSummary(filteredTasks) {
            const total = filteredTasks.length;
            const countByStatus = {
                ÏßÑÌñâÏ†Ñ: 0,
                ÏûëÏóÖÏ§ë: 0,
                ÏôÑÎ£å: 0
            };

            filteredTasks.forEach(task => {
                const status = task.status || "ÏßÑÌñâÏ†Ñ";
                countByStatus[status] = (countByStatus[status] || 0) + 1;
            });

            const label = selectedCenter === "ALL" ? "Ï†ÑÏ≤¥" : `${selectedCenter}`;
            const summaryText = `üìä ${label} Ï†ÑÏ≤¥: ${total} / ÏßÑÌñâÏ†Ñ: ${countByStatus["ÏßÑÌñâÏ†Ñ"]} / ÏûëÏóÖÏ§ë: ${countByStatus["ÏûëÏóÖÏ§ë"]} / ÏôÑÎ£å: ${countByStatus["ÏôÑÎ£å"]}`;

            document.getElementById("statusSummary").textContent = summaryText;
        }


        </script>
        
</body>
</html>

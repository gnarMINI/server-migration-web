<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서버 이전 리스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .box {
            border: 2px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            background: #fff;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        th {
            background: #ddd;
        }
        .status-progress {
            background-color: yellow;
        }
        .status-working {
            background-color: red;
            color: white;
        }
        .status-complete {
            background-color: gray;
            color: white;
        }
        .small-input {
            width: 70px;
        }
        select option[disabled] {
            color: gray;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-top: 0;  
            margin-bottom: 15px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            color: #333;
        }
        .inline-group {
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        .middle-input {
            width: 80px;
        }
        .link-input {
            width: 500px;
        }
        .status-default {
            background-color: white;
            color: black;
        }

        .status-working {
            background-color: green;
            color: white;
        }

        .status-complete {
            background-color: black;
            color: white;
        }
        .status-btn {
            border: none;
            padding: 6px 12px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
        }

        .status-default {
            background-color: white;
            color: black;
            border: 1px solid #ccc;
        }

        .status-working {
            background-color: green;
            color: white;
        }

        .status-complete {
            background-color: black;
            color: white;
        }
        .urgent-1week {
            background-color: #ffe5e5 !important;
        }
        .urgent-2week {
            background-color: #fff7d9 !important;
        }
        .urgent-3week {
            background-color: #ecf9ff !important;
        }



    </style>
</head>
<body>
    <div class="container">
        <div class="header">Kakao IDC team 서버 이전 리스트</div>
        <div class="box">
            <p class="section-title">작업 등록</p>
            <div class="inline-group">
                <label>서버 이전 종류: </label>  
                <select id="migrationType" onchange="toggleCenterSelect()">
                    <option value="" disabled selected>작업 종류 선택</option>
                    <option value="external">센터 간 이전</option>
                    <option value="internal">내부 이전</option>
                </select>
            </div>
            <div id="centerSelectSection" class="inline-group" style="display: none;">
                <label>센터 간 이전: </label>
                <select id="fromCenter">
                    <option value="" disabled selected>출발 센터</option>
                    <option>AY</option>
                    <option>AS</option>
                    <option>PG</option>
                    <option>MD</option>
                    <option>GS</option>
                    <option>HN</option>
                </select>
                &nbsp;to&nbsp;
                <select id="toCenter">
                    <option value="" disabled selected>도착 센터</option>
                    <option>AY</option>
                    <option>AS</option>
                    <option>PG</option>
                    <option>MD</option>
                    <option>GS</option>
                    <option>HN</option>
                </select>
            </div>
            <div id="internalCenterSection" class="inline-group" style="display: none;">
                <label>작업 센터: </label>
                <select id="internalCenter">
                    <option value="" disabled selected>센터 선택</option>
                    <option>AY</option>
                    <option>AS</option>
                    <option>PG</option>
                    <option>MD</option>
                    <option>GS</option>
                    <option>HN</option>
                </select>
            </div>
            <br><br>
            <label>벤더: </label> <select id="vendor">
                <option value="" disabled selected>벤더 선택</option>
                <option value="kaytus">KAYTUS</option>
                <option value="xfusion">XFUSION</option>
                <option value="others">그 외</option>
                <option value="mixed">복합</option>
            </select> &nbsp;
            <label>서버 수: </label><input id="serverCount" class="small-input" type="number" min="0" placeholder=" Ex)10"> &nbsp;
            <label>요청자: </label><input id="requester" class="middle-input" type="text" placeholder=" EX) gnar"> &nbsp;
            <br><br>
            <label>희망 완료일: </label><input id="dueDate" type="date">
            <br><br>
            <label>파트 작업: <input id="partWork" type="checkbox"></label>
            <label>OS 재설치: <input id="osInstall" type="checkbox"></label>
            <br><br>
            <label>비고: </label><textarea id="memo" rows="1" cols="50"></textarea>
            <br><br>
            <label>Agit Link: </label><input id="agitLink" class="link-input" type="text" placeholder="링크를 통하여 검색되니 정확히 입력부탁드립니다."> 
            <button id="saveTaskButton" onclick="saveTask()">SAVE</button>
            <button id="resetBtn" onclick="resetForm()">초기화</button>
            <button id="cancelBtn" onclick="cancelEdit()" style="display: none;">취소</button>

        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>진행 상태</th>                       
                        <th>희망 완료일</th>
                        <th>현재 서버 위치</th>
                        <th>작업 종류</th>
                        <th>작업 내용</th>
                        <th>서버 수</th>
                        <th>요청자</th>
                        <th>센터 이동 완료</th>
                        <th>작업 파일</th>
                        <th>마운트</th>
                        <th>포설</th>
                        <th>파트 작업</th>
                        <th>OS 설치</th>
                        <th>서버 설정</th>
                        <th>파트 반납</th>
                        <th>비고</th>
                        <th>Agit link</th>
                        <th>관리</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <script>
        function toggleCenterSelect() {
            const type = document.getElementById("migrationType").value;
            document.getElementById("centerSelectSection").style.display = (type === "external") ? "inline-block" : "none";
            document.getElementById("internalCenterSection").style.display = (type === "internal") ? "inline-block" : "none";
        }

        function collectFormData() {
            const migrationType = document.getElementById("migrationType").value;
            const vendor = document.getElementById("vendor").value;
            const serverCount = document.getElementById("serverCount").value;
            const requester = document.getElementById("requester").value;
            const dueDate = document.getElementById("dueDate").value;
            const partWork = document.getElementById("partWork").checked ? "unchecked" : "✖";
            const reinstallOS = document.getElementById("osInstall").checked ? "unchecked" : "✖";
            const memo = document.getElementById("memo").value;
            const agitLink = document.getElementById("agitLink").value;
            const centerMoved = false;
            const workFile = false;
            const mount = false;
            const cabling = false;
            const serverConfig = false;
            const partReturn = false;

            let center = "";
            let currentLocation = "";

            if (migrationType === "external") {
                const from = document.getElementById("fromCenter").value;
                const to = document.getElementById("toCenter").value;
                center = `${from} → ${to}`;
                currentLocation = from; // ✅ 최초는 fromCenter
            } else if (migrationType === "internal") {
                const internal = document.getElementById("internalCenter").value;
                center = `${internal} → ${internal}`;
                currentLocation = internal; // ✅ 내부 이전이면 하나
            }

            return {
                migrationType, center, currentLocation, vendor, serverCount, requester, dueDate,
                partWork, reinstallOS, memo, agitLink,
                centerMoved, workFile, mount, cabling, serverConfig, partReturn
            };

        }

        async function saveTask() {
            if (!validateForm()) return;

            const data = collectFormData();
            try {
                const res = await fetch("/api/tasks", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    alert("✅ 저장 완료!");
                    resetForm();
                    fetchAndDisplayTasks();
                } else {
                    alert("❌ 저장 실패: " + result.error);
                }
            } catch (error) {
                console.error("에러 발생:", error);
                alert("⚠️ 네트워크 오류");
            }
        }

        async function updateTask(id) {
            if (!validateForm()) return;

            const data = collectFormData();
            try {
                const res = await fetch(`/api/tasks/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                alert("✅ 수정 완료");
                resetForm();
                fetchAndDisplayTasks();
                const btn = document.getElementById("saveTaskButton");
                btn.textContent = "SAVE";
                btn.onclick = saveTask;
            } catch (err) {
                console.error(err);
                alert("❌ 수정 실패");
            }
            

        }

        async function editTask(id) {
            try {
                const res = await fetch(`/api/tasks`);
                const data = await res.json();
                const task = data.find(t => t._id === id);
                if (!task) return alert("작업을 찾을 수 없습니다.");
                document.getElementById("migrationType").value = task.migrationType;
                toggleCenterSelect();
                if (task.migrationType === "external") {
                    const [from, to] = task.center.split(" → ");
                    document.getElementById("fromCenter").value = from;
                    document.getElementById("toCenter").value = to;
                } else {
                    const [center] = task.center.split(" → ");
                    document.getElementById("internalCenter").value = center;
                }
                document.getElementById("vendor").value = task.vendor;
                document.getElementById("serverCount").value = task.serverCount;
                document.getElementById("requester").value = task.requester;
                document.getElementById("dueDate").value = task.dueDate;
                document.getElementById("partWork").checked = task.partWork;
                document.getElementById("osInstall").checked = task.reinstallOS;
                document.getElementById("memo").value = task.memo;
                document.getElementById("agitLink").value = task.agitLink;
                const btn = document.getElementById("saveTaskButton");
                btn.textContent = "UPDATE";
                btn.onclick = () => updateTask(id);
                document.getElementById("cancelBtn").style.display = "inline-block";
                document.getElementById("resetBtn").style.display = "none"; // 초기화 숨김
            } catch (err) {
                console.error(err);
                alert("❌ 수정 모드 진입 실패");
            }
        }

        async function fetchAndDisplayTasks() {
            try {
                const res = await fetch("/api/tasks");
                const tasks = await res.json();
                const table = document.querySelector("table");
                let tableBody = table.querySelector("tbody");
                if (!tableBody) {
                    tableBody = document.createElement("tbody");
                    table.appendChild(tableBody);
                }
                tableBody.innerHTML = "";

                tasks.forEach(task => {
                    const row = document.createElement("tr");
                    const statusLabel = task.status || "진행전";

                    let statusClass = "";
                    if (statusLabel === "작업중") statusClass = "status-working";
                    else if (statusLabel === "완료") statusClass = "status-complete";
                    else statusClass = "status-default"; // 진행전

                    if (task.dueDate) {
                        const dueDate = new Date(task.dueDate);
                        const now = new Date();
                        const diffDays = Math.floor((dueDate - now) / (1000 * 60 * 60 * 24));

                        if (diffDays <= 7) {
                            row.classList.add("urgent-1week"); // 빨강
                        } else if (diffDays <= 14) {
                            row.classList.add("urgent-2week"); // 노랑
                        } else if (diffDays <= 21) {
                            row.classList.add("urgent-3week"); // 하늘
                        }
                    }

                    row.innerHTML = `
                        <td>
                            <button 
                                onclick="toggleStatus('${task._id}', '${statusLabel}')" 
                                class="status-btn ${statusClass}" 
                                title="클릭하여 상태 변경">
                                ${statusLabel}
                            </button>
                        </td>
                        <td>${task.dueDate || "-"}</td>
                        <td>
                            <button 
                                onclick="toggleLocation('${task._id}', '${task.currentLocation}', '${task.center}', '${task.migrationType}')"
                                title="클릭하여 위치 변경">
                                ${task.currentLocation}
                            </button>
                        </td>
                        <td>${task.migrationType === "external" ? "센터 간 이전" : "내부 이전"}</td>
                        <td>${task.center}</td>
                        <td>${task.serverCount}</td>
                        <td>${task.requester}</td>
                        <td>${renderCheckbox(task.centerMoved, task._id, 'centerMoved')}</td>
                        <td>${renderCheckbox(task.workFile, task._id, 'workFile')}</td>
                        <td>${renderCheckbox(task.mount, task._id, 'mount')}</td>
                        <td>${renderCheckbox(task.cabling, task._id, 'cabling')}</td>
                        <td>${renderCustomCheckbox(task._id, 'partWork', task.partWork)}</td>
                        <td>${renderCustomCheckbox(task._id, 'reinstallOS', task.reinstallOS)}</td>
                        <td>${renderCheckbox(task.serverConfig, task._id, 'serverConfig')}</td>
                        <td>${renderCheckbox(task.partReturn, task._id, 'partReturn')}</td>
                        <td>${task.memo || ""}</td>
                        <td><a href="${task.agitLink}" target="_blank">${task.agitLink}</a></td>
                        <td>
                            <button onclick="editTask('${task._id}')">✏️</button>
                            <button onclick="deleteTask('${task._id}')">🗑️</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } 
            
            catch (err) {
                console.error("❌ 작업 목록 불러오기 실패:", err);
            }
        }

        async function toggleLocation(id, currentLocation, center, migrationType) {
            if (migrationType === "internal") return;

            const [from, to] = center.split(" → ");
            const newLocation = (currentLocation === from) ? to : from;

            try {
                const res = await fetch(`/api/tasks/${id}/location`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ currentLocation: newLocation })
                });
                const result = await res.json();
                if (res.ok) {
                    fetchAndDisplayTasks();
                } else {
                    alert("❌ 위치 변경 실패");
                }
            } catch (err) {
                console.error(err);
                alert("⚠️ 위치 변경 중 오류");
            }
        }



        function resetForm() {
            document.getElementById("migrationType").value = "";
            document.getElementById("vendor").value = "";
            document.getElementById("fromCenter").value = "";
            document.getElementById("toCenter").value = "";
            document.getElementById("internalCenter").value = "";
            document.getElementById("serverCount").value = "";
            document.getElementById("requester").value = "";
            document.getElementById("dueDate").value = "";
            document.getElementById("partWork").checked = false;
            document.getElementById("osInstall").checked = false;
            document.getElementById("memo").value = "";
            document.getElementById("agitLink").value = "";

            toggleCenterSelect(); // 센터 선택창 초기화

            const saveBtn = document.getElementById("saveTaskButton");
            saveBtn.textContent = "SAVE";
            saveBtn.onclick = saveTask;

            document.getElementById("cancelBtn").style.display = "none";
            document.getElementById("resetBtn").style.display = "inline-block";
        }




        function cancelEdit() {
            resetForm(); // 입력값 초기화
            document.getElementById("cancelBtn").style.display = "none"; // 버튼 숨기기
        }

        async function toggleStatus(id, currentStatus) {
            const nextStatus =
                currentStatus === "진행전" ? "작업중" :
                currentStatus === "작업중" ? "완료" : "진행전";

            try {
                const res = await fetch(`/api/tasks/${id}/status`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status: nextStatus })
                });
                const result = await res.json();
                if (res.ok) {
                    fetchAndDisplayTasks(); // 상태 갱신 후 테이블 다시 로딩
                } else {
                    alert("❌ 상태 업데이트 실패: " + result.error);
                }
            } catch (err) {
                console.error("상태 변경 오류:", err);
                alert("⚠️ 상태 변경 중 오류 발생");
            }
        }


        

        function toggleCheckbox(checkbox, id, field) {
            const checked = checkbox.checked;

            fetch(`/api/tasks/${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ [field]: checked })
            })
            .then(res => res.json())
            .then(result => {
                if (!result || !result.success) {
                    alert("❌ 상태 업데이트 실패");
                    checkbox.checked = !checked; // 롤백
                }
            })
            .catch(err => {
                console.error("🔧 상태 반영 오류:", err);
                alert("⚠️ 서버 오류로 인해 반영되지 않았습니다.");
                checkbox.checked = !checked; // 롤백
            });
        }


        function renderCheckbox(checked, id, field) {
            console.log("📌 renderCheckbox - id:", id, "field:", field);
            return `<input type="checkbox" ${checked ? "checked" : ""} onclick="toggleCheckbox(this, '${id}', '${field}')" />`;
        }


        async function deleteTask(id) {
            const confirmDelete = confirm("정말 삭제하시겠습니까?");
            if (!confirmDelete) return;

            try {
                const res = await fetch(`/api/tasks/${id}`, {
                    method: "DELETE",
                });
                const result = await res.json();
                if (res.ok) {
                    alert("🗑️ 삭제 완료!");
                    fetchAndDisplayTasks(); // 테이블 갱신
                } else {
                    alert("❌ 삭제 실패: " + result.error);
                }
            } catch (err) {
                console.error("삭제 오류:", err);
                alert("⚠️ 서버 오류로 삭제 실패");
            }
        }

        function validateForm() {
            const migrationType = document.getElementById("migrationType").value;
            const fromCenter = document.getElementById("fromCenter").value;
            const toCenter = document.getElementById("toCenter").value;
            const internalCenter = document.getElementById("internalCenter").value;
            const vendor = document.getElementById("vendor").value;
            const serverCount = document.getElementById("serverCount").value;
            const requester = document.getElementById("requester").value;

            // 공통 필수값 검사
            if (!migrationType) {
                alert("서버 이전 종류를 선택해주세요.");
                return false;
            }

            if (document.getElementById("vendor").selectedIndex === 0) {
                alert("벤더를 선택해주세요.");
                return false;
            }

            // 외부 이전일 경우 센터 모두 선택했는지 확인
            if (migrationType === "external") {
                if (
                    document.getElementById("fromCenter").selectedIndex === 0 ||
                    document.getElementById("toCenter").selectedIndex === 0
                ) {
                    alert("출발 센터와 도착 센터를 모두 선택해주세요.");
                    return false;
                }
            }

            // 내부 이전일 경우 센터 선택 확인
            if (migrationType === "internal") {
                if (!internalCenter) {
                    alert("내부 이전 센터를 선택해주세요.");
                    return false;
                }
            }

            if (!serverCount || serverCount <= 0) {
                alert("서버 수를 입력해주세요.");
                return false;
            }

            if (!requester) {
                alert("작업 요청자를 입력해주세요.");
                return false;
            }



            return true; // 검증 통과
        }

        function renderCustomCheckbox(id, field, value) {
            if (value === "✖") return "✖";

            const isChecked = value === "checked" ? "checked" : "";
            return `<input type="checkbox" ${isChecked} onclick="toggleCustomCheckbox(this, '${id}', '${field}')" />`;
        }

        function toggleCustomCheckbox(checkbox, id, field) {
            const newValue = checkbox.checked ? "checked" : "unchecked";

            fetch(`/api/tasks/${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ [field]: newValue })
            })
            .then(res => res.json())
            .then(result => {
                if (!result || !result.success) {
                    alert("❌ 상태 반영 실패");
                    checkbox.checked = !checkbox.checked; // 롤백
                }
            })
            .catch(err => {
                console.error("체크박스 반영 오류:", err);
                alert("⚠️ 서버 오류");
                checkbox.checked = !checkbox.checked;
            });
        }




        window.onload = fetchAndDisplayTasks;


    </script>
</body>
</html>
